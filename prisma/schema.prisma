generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                    String                 @id @default(cuid())
  email                 String                 @unique
  passwordHash          String?
  name                  String?
  phone                 String?
  emailVerified         Boolean                @default(false)
  isActive              Boolean                @default(true)
  role                  UserRole               @default(CUSTOMER)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  twoFactorEnabled      Boolean                @default(false)
  twoFactorSecret       String?
  addresses             Address[]
  giftCardUsages        GiftCardUsage[]
  loyaltyAccount        LoyaltyAccount?
  orders                Order[]
  quickCheckoutSessions QuickCheckoutSession[]
  reviews               Review[]
  savedAddresses        SavedAddress[]
  savedComparisons      SavedComparison[]
  savedPaymentMethods   SavedPaymentMethod[]
  searchHistory         SearchHistory[]
  sessions              Session[]
  voucherUsages         VoucherUsage[]
  waitlist              Waitlist[]
  wishlists             Wishlist[]             @relation("UserWishlists")

  @@index([email])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Address {
  id        String   @id @default(cuid())
  userId    String
  type      String   @default("shipping")
  street    String
  city      String
  state     String
  zipCode   String
  country   String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Category {
  id          String      @id @default(cuid())
  name        String
  slug        String      @unique
  description String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  imageUrl    String?
  parentId    String?
  parent      Category?   @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[]  @relation("CategoryHierarchy")
  products    Product[]
  sizeGuides  SizeGuide[]
}

model Product {
  id                String          @id @default(cuid())
  name              String
  slug              String          @unique
  description       String
  price             Decimal         @db.Decimal(10, 2)
  categoryId        String
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  barcode           String?
  compareAtPrice    Decimal?        @db.Decimal(10, 2)
  costPrice         Decimal?        @db.Decimal(10, 2)
  isActive          Boolean         @default(true)
  isFeatured        Boolean         @default(false)
  lowStockThreshold Int             @default(5)
  material          String?
  origin            String?
  shortDescription  String?
  sku               String          @unique
  stockQuantity     Int             @default(0)
  weight            Decimal?        @db.Decimal(8, 2)
  inventory         Inventory?
  orderItems        OrderItem[]
  category          Category        @relation(fields: [categoryId], references: [id])
  reviews           Review[]
  sizeGuides        SizeGuide[]
  stockMovements    StockMovement[]
  waitlist          Waitlist[]
  wishlists         Wishlist[]      @relation("ProductWishlists")

  @@index([categoryId])
  @@index([slug])
  @@index([isActive, isFeatured])
}

model Coupon {
  id                 String       @id @default(cuid())
  code               String       @unique
  description        String?
  discountType       DiscountType
  discountValue      Decimal      @db.Decimal(10, 2)
  minimumOrderAmount Decimal?     @db.Decimal(10, 2)
  usageLimit         Int?
  timesUsed          Int          @default(0)
  expirationDate     DateTime?
  isActive           Boolean      @default(true)
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
}

model StockMovement {
  id        String       @id @default(cuid())
  productId String
  quantity  Int
  type      MovementType
  reason    String?
  createdAt DateTime     @default(now())
  product   Product      @relation(fields: [productId], references: [id])

  @@index([productId])
}

model Order {
  id             String          @id @default(cuid())
  userId         String
  status         OrderStatus     @default(PENDING)
  total          Decimal         @db.Decimal(10, 2)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  discount       Decimal         @default(0) @db.Decimal(10, 2)
  notes          String?
  orderNumber    String          @unique
  paymentId      String?         @unique
  paymentMethod  String?
  paymentStatus  PaymentStatus   @default(PENDING)
  shippingCost   Decimal         @db.Decimal(10, 2)
  subtotal       Decimal         @db.Decimal(10, 2)
  tax            Decimal         @db.Decimal(10, 2)
  giftCardUsages GiftCardUsage[]
  user           User            @relation(fields: [userId], references: [id])
  items          OrderItem[]
  tracking       OrderTracking?
  voucherUsages  VoucherUsage[]

  @@index([userId])
  @@index([orderNumber])
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  productId String
  quantity  Int
  price     Decimal @db.Decimal(10, 2)
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Wishlist {
  id        String   @id @default(cuid())
  userId    String
  productId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product  @relation("ProductWishlists", fields: [productId], references: [id])
  user      User     @relation("UserWishlists", fields: [userId], references: [id])

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
}

model Review {
  id        String   @id @default(cuid())
  productId String
  userId    String
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@index([productId])
  @@index([userId])
}

model AnalyticsEvent {
  id        String   @id @default(cuid())
  eventType String
  userId    String?
  productId String?
  orderId   String?
  revenue   Decimal? @db.Decimal(10, 2)
  path      String?
  createdAt DateTime @default(now())

  @@index([eventType])
  @@index([userId])
  @@index([productId])
  @@index([orderId])
  @@index([createdAt])
}

model ShippingRate {
  id             String   @id @default(cuid())
  name           String   @unique
  description    String?
  price          Decimal  @db.Decimal(10, 2)
  minWeight      Decimal? @db.Decimal(8, 2)
  maxWeight      Decimal? @db.Decimal(8, 2)
  minOrderAmount Decimal? @db.Decimal(10, 2)
  maxOrderAmount Decimal? @db.Decimal(10, 2)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model TaxRate {
  id        String   @id @default(cuid())
  name      String
  country   String
  state     String?
  city      String?
  zipCode   String?
  rate      Decimal  @db.Decimal(5, 4)
  isDefault Boolean  @default(false)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([country, state, city, zipCode])
  @@index([country])
  @@index([isActive])
}

model Inventory {
  id                String                 @id @default(cuid())
  productId         String                 @unique
  sku               String?
  quantity          Int                    @default(0)
  reserved          Int                    @default(0)
  available         Int                    @default(0)
  reorderLevel      Int                    @default(10)
  reorderQuantity   Int                    @default(50)
  warehouseLocation String?
  lastRestocked     DateTime?
  lastReserved      DateTime?
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  product           Product                @relation(fields: [productId], references: [id], onDelete: Cascade)
  logs              InventoryLog[]
  reservations      InventoryReservation[]

  @@index([productId])
  @@index([quantity])
}

model InventoryReservation {
  id         String    @id @default(cuid())
  productId  String
  quantity   Int
  orderId    String
  userId     String?
  status     String    @default("active")
  expiresAt  DateTime
  createdAt  DateTime  @default(now())
  releasedAt DateTime?
  inventory  Inventory @relation(fields: [productId], references: [productId], onDelete: Cascade)

  @@index([orderId])
  @@index([expiresAt])
  @@index([status])
}

model InventoryLog {
  id             String    @id @default(cuid())
  productId      String
  quantityChange Int
  newQuantity    Int
  reason         String
  userId         String?
  orderId        String?
  notes          String?
  createdAt      DateTime  @default(now())
  inventory      Inventory @relation(fields: [productId], references: [productId], onDelete: Cascade)

  @@index([productId])
  @@index([reason])
  @@index([createdAt])
}

model OrderTracking {
  id                 String                 @id @default(cuid())
  orderId            String                 @unique
  trackingNumber     String                 @unique
  carrier            String
  shippingLabel      String?
  currentStatus      String
  estimatedDelivery  DateTime?
  actualDelivery     DateTime?
  lastUpdated        DateTime               @default(now())
  carrierTrackingUrl String?
  carrierStatusCode  String?
  processedAt        DateTime?
  shippedAt          DateTime?
  deliveredAt        DateTime?
  weight             Decimal?
  dimensions         String?
  notes              String?
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  order              Order                  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  events             TrackingEvent[]
  notifications      TrackingNotification[]

  @@index([orderId])
  @@index([trackingNumber])
  @@index([carrier])
  @@index([currentStatus])
  @@index([estimatedDelivery])
}

model TrackingEvent {
  id               String        @id @default(cuid())
  orderId          String
  status           String
  statusType       String
  timestamp        DateTime      @default(now())
  location         String?
  city             String?
  state            String?
  country          String?
  description      String
  carrierEventCode String?
  trackingNumber   String?
  sequenceNumber   Int           @default(0)
  isDelivered      Boolean       @default(false)
  tracking         OrderTracking @relation(fields: [orderId], references: [orderId], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
  @@index([timestamp])
}

model TrackingNotification {
  id            String        @id @default(cuid())
  orderId       String
  type          String
  recipient     String
  subject       String?
  message       String
  status        String        @default("pending")
  sentAt        DateTime?
  failureReason String?
  eventType     String?
  metadata      String?
  createdAt     DateTime      @default(now())
  tracking      OrderTracking @relation(fields: [orderId], references: [orderId], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
}

model SearchHistory {
  id               String   @id @default(cuid())
  userId           String
  query            String
  queryType        String   @default("text")
  filters          String?
  resultCount      Int      @default(0)
  clickedProduct   String?
  clickPosition    Int?
  durationSeconds  Int      @default(0)
  hadResults       Boolean  @default(false)
  convertedToOrder Boolean  @default(false)
  orderId          String?
  ipAddress        String?
  userAgent        String?
  timestamp        DateTime @default(now())
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([query])
  @@index([timestamp])
  @@index([convertedToOrder])
}

model LoyaltyAccount {
  id                    String          @id @default(cuid())
  userId                String          @unique
  currentTier           String          @default("bronze")
  totalPoints           Int             @default(0)
  availablePoints       Int             @default(0)
  totalSpent            Decimal         @default(0)
  totalPurchases        Int             @default(0)
  averageOrderValue     Decimal         @default(0)
  birthDay              Int?
  birthMonth            Int?
  birthYearLastRedeemed Int?
  memberSince           DateTime        @default(now())
  lastPurchaseDate      DateTime?
  inactiveDate          DateTime?
  tierReachedAt         DateTime?
  nextTierProjectedDate DateTime?
  statusRiskLevel       String?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  user                  User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  rewards               LoyaltyReward[]
  pointsHistory         PointsHistory[]

  @@index([userId])
  @@index([currentTier])
  @@index([totalPoints])
  @@index([lastPurchaseDate])
}

model PointsHistory {
  id           String         @id @default(cuid())
  userId       String
  pointsAmount Int
  pointsType   String
  sourceType   String
  sourceId     String?
  multiplier   Decimal        @default(1)
  baseAmount   Decimal?
  reason       String?
  notes        String?
  expiresAt    DateTime?
  isExpired    Boolean        @default(false)
  createdAt    DateTime       @default(now())
  expiredAt    DateTime?
  account      LoyaltyAccount @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId])
  @@index([pointsType])
  @@index([sourceType])
  @@index([createdAt])
  @@index([expiresAt])
}

model LoyaltyReward {
  id              String         @id @default(cuid())
  userId          String
  name            String
  description     String?
  rewardType      String
  value           Decimal
  status          String         @default("available")
  minTierRequired String?
  expiresAt       DateTime?
  redeemedAt      DateTime?
  createdAt       DateTime       @default(now())
  account         LoyaltyAccount @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model GiftCard {
  id               String          @id @default(cuid())
  code             String          @unique
  sku              String?
  initialValue     Decimal
  currentBalance   Decimal
  status           String          @default("active")
  expiresAt        DateTime
  purchasedAt      DateTime        @default(now())
  firstUsedAt      DateTime?
  fullyUsedAt      DateTime?
  purchasedBy      String?
  purchasedByEmail String?
  recipientName    String?
  recipientEmail   String?
  notes            String?
  customMessage    String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  usage            GiftCardUsage[]

  @@index([code])
  @@index([status])
  @@index([expiresAt])
}

model GiftCardUsage {
  id         String   @id @default(cuid())
  giftCardId String
  orderId    String?
  userId     String?
  amountUsed Decimal
  notes      String?
  createdAt  DateTime @default(now())
  giftCard   GiftCard @relation(fields: [giftCardId], references: [id], onDelete: Cascade)
  order      Order?   @relation(fields: [orderId], references: [id])
  user       User?    @relation(fields: [userId], references: [id])

  @@index([giftCardId])
  @@index([orderId])
  @@index([userId])
}

model Voucher {
  id                   String         @id @default(cuid())
  code                 String         @unique
  name                 String
  description          String?
  discountType         String
  discountValue        Decimal
  maxDiscount          Decimal?
  minDiscount          Decimal?
  minOrderValue        Decimal        @default(0)
  maxOrderValue        Decimal?
  applicableCategories String?
  excludedProducts     String?
  maxUsages            Int?
  maxUsagePerUser      Int            @default(1)
  currentUsages        Int            @default(0)
  startDate            DateTime
  expiresAt            DateTime
  isActive             Boolean        @default(true)
  requiresCode         Boolean        @default(true)
  createdBy            String?
  campaign             String?
  notes                String?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  usage                VoucherUsage[]

  @@index([code])
  @@index([isActive])
  @@index([expiresAt])
}

model VoucherUsage {
  id             String   @id @default(cuid())
  voucherId      String
  orderId        String?
  userId         String?
  discountAmount Decimal
  orderTotal     Decimal
  finalTotal     Decimal
  appliedAt      DateTime @default(now())
  order          Order?   @relation(fields: [orderId], references: [id])
  user           User?    @relation(fields: [userId], references: [id])
  voucher        Voucher  @relation(fields: [voucherId], references: [id], onDelete: Cascade)

  @@index([voucherId])
  @@index([orderId])
  @@index([userId])
}

model SavedPaymentMethod {
  id                    String                 @id @default(cuid())
  userId                String
  type                  String
  token                 String
  last4                 String?
  cardholderName        String?
  expiryMonth           Int?
  expiryYear            Int?
  brand                 String?
  walletEmail           String?
  walletId              String?
  isDefault             Boolean                @default(false)
  isVerified            Boolean                @default(true)
  billingZip            String?
  billingCountry        String?
  lastUsedAt            DateTime?
  failedAttempts        Int                    @default(0)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  quickCheckoutSessions QuickCheckoutSession[]
  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isDefault])
}

model SavedAddress {
  id                    String                 @id @default(cuid())
  userId                String
  type                  String
  label                 String?
  fullName              String
  phone                 String?
  email                 String?
  streetAddress         String
  streetAddress2        String?
  city                  String
  state                 String
  postalCode            String
  country               String
  isDefault             Boolean                @default(false)
  isPrimary             Boolean                @default(false)
  isResidential         Boolean                @default(true)
  isVerified            Boolean                @default(false)
  verificationStatus    String?
  lastUsedAt            DateTime?
  usageCount            Int                    @default(0)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  quickCheckoutSessions QuickCheckoutSession[]
  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([isDefault])
  @@index([country])
}

model QuickCheckoutSession {
  sessionId         String             @id @default(cuid())
  userId            String
  productId         String
  quantity          Int
  paymentMethodId   String
  shippingAddressId String
  billingAddressId  String?
  subtotal          Decimal?
  shippingCost      Decimal?
  taxAmount         Decimal?
  totalAmount       Decimal?
  status            String             @default("active")
  orderId           String?
  completedAt       DateTime?
  expiresAt         DateTime
  isExpired         Boolean            @default(false)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  paymentMethod     SavedPaymentMethod @relation(fields: [paymentMethodId], references: [id], onDelete: Cascade)
  shippingAddress   SavedAddress       @relation(fields: [shippingAddressId], references: [id], onDelete: Cascade)
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([expiresAt])
}

model BlogCategory {
  id             String     @id @default(cuid())
  name           String
  slug           String     @unique
  description    String?
  image          String?
  seoTitle       String?
  seoDescription String?
  isActive       Boolean    @default(true)
  postCount      Int        @default(0)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  posts          BlogPost[]

  @@index([slug])
  @@index([isActive])
}

model BlogPost {
  id                 String       @id @default(cuid())
  title              String
  slug               String       @unique
  content            String
  excerpt            String
  author             String
  categoryId         String
  tags               String?
  image              String?
  imageAlt           String?
  status             String       @default("draft")
  featured           Boolean      @default(false)
  seoTitle           String?
  seoDescription     String?
  seoKeywords        String?
  viewCount          Int          @default(0)
  viewsLastMonth     Int          @default(0)
  viewsLastWeek      Int          @default(0)
  likes              Int          @default(0)
  comments           Int          @default(0)
  shares             Int          @default(0)
  readingTimeMinutes Int?
  wordCount          Int          @default(0)
  publishedAt        DateTime?
  scheduledFor       DateTime?
  updatedBy          String?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  category           BlogCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([slug])
  @@index([status])
  @@index([categoryId])
  @@index([publishedAt])
  @@index([featured])
  @@index([viewCount])
}

model SizeGuide {
  id               String    @id @default(cuid())
  productId        String?
  categoryId       String
  name             String
  description      String?
  measurements     String
  fitDescription   String?
  fitImages        String?
  conversionCharts String?
  usageCount       Int       @default(0)
  lastViewedAt     DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  category         Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  product          Product?  @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([categoryId])
}

model SavedComparison {
  id           String    @id @default(cuid())
  userId       String
  name         String
  productIds   String
  description  String?
  productCount Int       @default(0)
  isPublic     Boolean   @default(false)
  shareToken   String?
  viewCount    Int       @default(0)
  lastViewedAt DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isPublic])
}

model Waitlist {
  id                 String    @id @default(cuid())
  userId             String
  productId          String
  email              String
  phone              String?
  status             String    @default("active")
  notifiedAt         DateTime?
  notificationMethod String?
  position           Int?
  addedAt            DateTime  @default(now())
  waitDate           Int       @default(0)
  allowNotifications Boolean   @default(true)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  product            Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
  @@index([status])
  @@index([notifiedAt])
}

enum UserRole {
  CUSTOMER
  ADMIN
}

enum MovementType {
  IN
  OUT
  ADJUSTMENT
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  IN_TRANSIT
  DELIVERED
  CANCELLED
  RETURNED
  OUT_FOR_DELIVERY
  CONFIRMED
  REFUNDED
  PAYMENT_FAILED
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  PAID
  FAILED
  REFUNDED
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}
